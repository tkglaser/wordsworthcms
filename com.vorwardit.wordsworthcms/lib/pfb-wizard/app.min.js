var app=angular.module("RequestApp",["ngAnimate","ngRoute","ui.bootstrap","ui.date"]);app.config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{reloadOnSearch:!1,templateUrl:"lib/pfb-wizard/Views/Landing.html",controller:"LandingController"}).when("/von-:startSearch",{reloadOnSearch:!1,templateUrl:"lib/pfb-wizard/Views/Landing.html",controller:"LandingController"}).when("/nach-:targetSearch",{reloadOnSearch:!1,templateUrl:"lib/pfb-wizard/Views/Landing.html",controller:"LandingController"}).when("/von-:startSearch/nach-:targetSearch",{reloadOnSearch:!1,templateUrl:"lib/pfb-wizard/Views/Landing.html",controller:"LandingController"}).when("/request",{reloadOnSearch:!1,templateUrl:"lib/pfb-wizard/Views/Request.html",controller:"RequestController"}).when("/order/:requestId/:offerId",{templateUrl:"lib/pfb-wizard/Views/Order.html",controller:"OrderController",resolve:{offer:["requestFactory","$route",function(e,t){return e.offer(t.current.params.requestId,t.current.params.offerId)}],request:["requestFactory","$route",function(e,t){return e.get(t.current.params.requestId)}]}}).when("/orderconfirm/:requestId/:offerId/:paymode",{templateUrl:"lib/pfb-wizard/Views/OrderConfirm.html",controller:"OrderConfirmController",resolve:{offer:["requestFactory","$route",function(e,t){return e.offer(t.current.params.requestId,t.current.params.offerId)}],request:["requestFactory","$route",function(e,t){return e.get(t.current.params.requestId)}]}}).when("/booking/:requestId",{templateUrl:"lib/pfb-wizard/Views/Booking.html",controller:"BookingController",resolve:{request:["requestFactory","$route",function(e,t){return e.get(t.current.params.requestId)}]}}).when("/cannotQuote/:requestId",{templateUrl:"lib/pfb-wizard/Views/CannotQuote.html",controller:"CannotQuoteController",resolve:{request:["requestFactory","$route",function(e,t){return e.get(t.current.params.requestId)}]}}).when("/offerExpired/:requestId",{templateUrl:"lib/pfb-wizard/Views/OfferExpired.html",controller:"OfferExpiredController",resolve:{request:["requestFactory","$route",function(e,t){return e.get(t.current.params.requestId)}]}}).when("/specialRequest/:requestId",{templateUrl:"lib/pfb-wizard/Views/SpecialRequest.html",controller:"SpecialRequestController",resolve:{request:["requestFactory","$route",function(e,t){return e.get(t.current.params.requestId)}]}}).when("/payment/:result/:requestId/:paymentId/:offerId",{templateUrl:"lib/pfb-wizard/Views/Processing.html",controller:"PaymentController"}).otherwise({redirectTo:"/"}),t.html5Mode(!0)}]),app.constant("apiEndPoint",PFBConfig.apiEndpoint),app.constant("clientId",PFBConfig.clientId),app.controller("BookingController",["$scope","$routeParams","$window","$log","$sce","$timeout","$location","requestFactory","bookingFactory","mailerFactory","request","analyticsFactory",function(e,t,r,a,n,o,s,i,u,c,d,l){e.request=d.data,e.requestId=t.requestId,e.isMailFormShown=!1,e.emailForSending=e.request.email,e.emailBeingSent=!1,e.mailSendSuccess=!1,e.$on("$viewContentLoaded",function(e){l.pageView("/app/booking")}),e.request.safeProductDescription=n.trustAsHtml(e.request.productDescription),e.print=function(){r.print()},e.showMailForm=function(){e.isMailFormShown=!0},e.sendMail=function(){e.emailBeingSent=!0,c.sendMail({Id:e.requestId,Type:"orderconfirmation",Email:e.emailForSending}).success(function(){e.emailBeingSent=!1,e.mailSendSuccess=!0,o(function(){e.mailSendSuccess=!1,e.isMailFormShown=!1},2e3)})},$("body,html").scrollTop(0)}]),app.controller("CannotQuoteController",["$scope","$routeParams","$window","$log","$sce","$location","requestFactory","request","analyticsFactory",function(e,t,r,a,n,o,s,i,u){e.request=i.data,e.requestId=t.requestId,e.success=!1,e.$on("$viewContentLoaded",function(e){u.pageView("/app/cannotquote")}),$("body,html").scrollTop(0),e.submit=function(){$("body,html").scrollTop(0),s.update({RequestId:e.requestId,Name:e.Name,Email:e.EMail}).success(function(){e.success=!0}).error(function(e){})}}]),app.controller("LandingController",["$routeParams","$scope","$location","$timeout","$q","$log","$window","gacFactory","requestFactory","utilFactory","analyticsFactory",function(e,t,r,a,n,o,s,i,u,c,d){t.requestId="",t.startIsValid=!1,t.targetIsValid=!1,t.StartLatLng=null,t.TargetLatLng=null,t.StartCountry="",t.TargetCountry="",t.mapSubmitted=!1,t.mapLoading=!1,t.startAutocomplete=null,t.targetAutocomplete=null,t.startPredictions=[],t.targetPredictions=[],t.gacValidationMessage="",t.ValueTrack={};var l=r.search();l.hasOwnProperty("k")&&(t.ValueTrack.KeyWord=l.k),l.hasOwnProperty("d")&&(t.ValueTrack.Device=l.d),l.hasOwnProperty("m")&&(t.ValueTrack.MatchType=l.m),r.search("k",null),r.search("d",null),r.search("m",null),""!=e.startSearch&&i.autocomplete(e.startSearch).success(function(e,r,a,n){"OK"==e.status&&t.setStartPlace(e.predictions[0])}),""!=e.targetSearch&&i.autocomplete(e.targetSearch).success(function(e,r,a,n){"OK"==e.status&&t.setTargetPlace(e.predictions[0])}),t.$on("$viewContentLoaded",function(e){d.pageView()}),$("body,html").scrollTop(0),t.startErrorClass=function(){return t.Request.StartName.$dirty||t.mapSubmitted?t.startIsValid?"has-success":"has-error":""},t.targetErrorClass=function(){return t.Request.TargetName.$dirty||t.mapSubmitted?t.targetIsValid?"has-success":"has-error":""},t.submitMap=function(){t.mapSubmitted=!0},t.redirectIfReady=function(e){return null==t.StartLatLng||null==t.TargetLatLng?(t.distance=0,void(t.duration=0)):(d.buttonClick("landing"),t.mapLoading=!0,void u.create().success(function(e){t.requestId=e}).then(function(){var e=$.extend({},t.ValueTrack,{RequestId:t.requestId,StartName:t.StartName,StartCountry:t.StartCountry,StartLat:t.StartLat,StartLon:t.StartLon,TargetName:t.TargetName,TargetCountry:t.TargetCountry,TargetLat:t.TargetLat,TargetLon:t.TargetLon});return u.update(e)}).then(function(e){"CannotQuote"==e.data.status?r.path("/cannotQuote/"+t.requestId):(r.path("/request"),r.search("r",t.requestId),r.search("s","d"))}))},t.onStartNameEdit=function(){t.startIsValid=!1,t.gacValidationMessage="";var e=t.StartName;""!=e&&i.autocomplete(e).success(function(e,r,a,n){"OK"==e.status?t.startPredictions=e.predictions:t.startPredictions=[]})},t.onTargetNameEdit=function(){t.targetIsValid=!1,t.gacValidationMessage="";var e=t.TargetName;""!=e&&i.autocomplete(e).success(function(e,r,a,n){"OK"==e.status?t.targetPredictions=e.predictions:t.targetPredictions=[]})},t.isCountry=function(e){for(var t=0;t<e.types.length;++t)if("country"===e.types[t])return!0;return!1},t.setStartPlace=function(e){i.details(e.place_id).success(function(e){if("OK"==e.status){var r=e.result;if(t.isCountry(r))return void(t.gacValidationMessage="Ein Land kann nicht als Abfahrtsort gewählt werden!");r.geometry&&(t.gacValidationMessage="",t.StartLat=r.geometry.location.lat,t.StartLon=r.geometry.location.lng,"Deutschland"===r.formatted_address?t.StartName=r.name+", "+r.formatted_address:t.StartName=r.formatted_address,t.startIsValid=!0,t.startPredictions=[],t.StartLatLng=r.geometry.location,t.StartCountry=c.getPlaceCountry(r),t.redirectIfReady())}})},t.setTargetPlace=function(e){i.details(e.place_id).success(function(e){if("OK"==e.status){var r=e.result;if(t.isCountry(r))return void(t.gacValidationMessage="Ein Land kann nicht als Ziel gewählt werden!");r.geometry&&(t.gacValidationMessage="",t.TargetLat=r.geometry.location.lat,t.TargetLon=r.geometry.location.lng,"Deutschland"===r.formatted_address?t.TargetName=r.name+", "+r.formatted_address:t.TargetName=r.formatted_address,t.targetIsValid=!0,t.targetPredictions=[],t.TargetLatLng=r.geometry.location,t.TargetCountry=c.getPlaceCountry(r),t.redirectIfReady())}})},t.cumulativeOffset=function(e){var t=0,r=0;do t+=e.offsetTop||0,r+=e.offsetLeft||0,e=e.offsetParent;while(e);return{top:t,left:r}},t.onDownArrowClick=function(){a(function(){var e=document.getElementById("mainNavbar"),r=e.clientHeight,a=document.getElementById("downArrow"),n=t.cumulativeOffset(a).top;o.info("nav is "+r+" high, jumping to "+n),$("body,html").animate({scrollTop:n},"slow")})}}]),app.controller("OfferExpiredController",["$scope","$routeParams","$window","$log","$sce","$location","requestFactory","request","analyticsFactory",function(e,t,r,a,n,o,s,i,u){e.request=i.data,e.requestId=t.requestId,e.success=!1,o.search("r",null),o.search("s",null),e.$on("$viewContentLoaded",function(e){u.pageView("/app/offerexpired")}),$("body,html").scrollTop(0)}]),app.controller("OrderConfirmController",["$scope","$routeParams","$window","$log","$sce","$location","bookingFactory","offer","request","analyticsFactory",function(e,t,r,a,n,o,s,i,u,c){e.offer=i.data,e.request=u.data,e.name=e.request.name,e.requestId=t.requestId,e.offerId=t.offerId,e.reserve={},e.paymode=t.paymode,e.redirecting=!1,e.submitted=!1,e.accepted=!1,e.$on("$viewContentLoaded",function(e){c.pageView("/app/orderconfirm")}),e.offer.safeProductDescription=n.trustAsHtml(e.offer.productDescription),$("body,html").scrollTop(0),e.acceptedStyle=function(){return e.submitted?e.accepted?"has-success":["has-error","emphasised"]:""},e.submit=function(){e.submitted=!0,e.accepted&&($("body,html").scrollTop(0),e.redirecting=!0,s.book({RequestId:e.requestId,OfferId:e.offerId,PayMode:e.paymode}).success(function(e){a.info(e),"Redirect"==e.result&&(r.location.href=e.data)}))}}]),app.controller("OrderController",["$scope","$routeParams","$window","$log","$location","$sce","requestFactory","offer","request","analyticsFactory",function(e,t,r,a,n,o,s,i,u,c){e.offer=i.data,e.request=u.data,e.name=e.request.name,e.email=e.request.email,e.organisation=e.request.organisation,e.street=e.request.address,e.town=e.request.town,e.postcode=e.request.postcode,e.requestId=t.requestId,e.offerId=t.offerId,e.form={},e.paymode="later",e.submitted=!1,e.$on("$viewContentLoaded",function(e){c.pageView("/app/order")}),e.offer.safeProductDescription=o.trustAsHtml(e.offer.productDescription),$("body,html").scrollTop(0),e.nameValidClass=function(){return e.form.name.$dirty||e.submitted?e.form.name.$valid?"has-success":"has-error":""},e.emailValidClass=function(){return e.form.email.$dirty||e.submitted?e.form.email.$valid?"has-success":"has-error":""},e.streetValidClass=function(){return e.form.street.$dirty||e.submitted?e.form.street.$valid?"has-success":"has-error":""},e.townValidClass=function(){return e.form.town.$dirty||e.submitted?e.form.town.$valid?"has-success":"has-error":""},e.postcodeValidClass=function(){return e.form.postcode.$dirty||e.submitted?e.form.postcode.$valid?"has-success":"has-error":""},e.submit=function(){if(e.submitted=!0,e.form.$valid){var t={RequestId:e.requestId,Name:e.name,Email:e.email,Organisation:e.organisation,Address:e.street,Town:e.town,PostCode:e.postcode};s.update(t).success(function(){n.path("/orderconfirm/"+e.requestId+"/"+e.offerId+"/"+e.paymode)})}}}]),app.controller("PaymentController",["$scope","$routeParams","$location","$log","requestFactory","bookingFactory",function(e,t,r,a,n,o){0===r.path().lastIndexOf("/payment/",0)&&o.pay({RequestId:t.requestId,PaymentId:t.paymentId,Result:t.result}).success(function(e){r.path("/booking/"+t.requestId)}).error(function(e){r.path("/offer/"+t.requestId+"/"+t.offerId)})}]),app.controller("RequestController",["$scope","$timeout","$location","$q","utilFactory","$log","$sce","$window","gacFactory","requestFactory","mailerFactory","analyticsFactory",function(e,t,r,a,n,o,s,i,u,c,d,l){function f(e){var t="0"+e;return t.substr(t.length-2)}e.locked=!0,e.requestId="",e.startIsValid=!1,e.targetIsValid=!1,e.startPredictions=[],e.targetPredictions=[],e.StartCountry="",e.TargetCountry="",e.showMap=!1,e.showNameSection=!1,e.distance=0,e.duration=0,e.map=null,e.StartLatLng=null,e.TargetLatLng=null,e.ds=new google.maps.DirectionsService,e.dr=new google.maps.DirectionsRenderer,e.Request={},e.offers=[],e.initFinished=!1,e.mapLoading=!1,e.offersLoading=!1,e.requestNumber=0,e.gacValidationMessage="",e.startErrorClass=function(){return e.startIsValid?"has-success":"has-error"},e.targetErrorClass=function(){return e.targetIsValid?"has-success":"has-error"},e.onStartNameEdit=function(){if(e.initFinished){e.gacValidationMessage="";var t=e.StartName;e.startIsValid=!1,e.getRequestId().then(function(){e.setStatus(""),""!=t&&u.autocomplete(t).success(function(t,r,a,n){"OK"==t.status?e.startPredictions=t.predictions:e.startPredictions=[]})})}},e.onTargetNameEdit=function(){if(e.initFinished){e.gacValidationMessage="";var t=e.TargetName;e.targetIsValid=!1,e.getRequestId().then(function(){e.setStatus(""),""!=t&&(e.targetIsValid=!1,u.autocomplete(t).success(function(t,r,a,n){"OK"==t.status?e.targetPredictions=t.predictions:e.targetPredictions=[]}))})}},e.isCountry=function(e){for(var t=0;t<e.types.length;++t)if("country"===e.types[t])return!0;return!1},e.setStartPlace=function(t){u.details(t.place_id).success(function(t){if("OK"==t.status){var r=t.result;if(e.isCountry(r))return void(e.gacValidationMessage="Ein Land kann nicht als Abfahrtsort gewählt werden!");r.geometry&&(e.gacValidationMessage="",e.StartLat=r.geometry.location.lat,e.StartLon=r.geometry.location.lng,"Deutschland"===r.formatted_address?e.StartName=r.name+", "+r.formatted_address:e.StartName=r.formatted_address,e.startIsValid=!0,e.startPredictions=[],e.StartLatLng=new google.maps.LatLng(r.geometry.location.lat,r.geometry.location.lng),e.StartCountry=n.getPlaceCountry(r),e.renderMapIfReady(!0))}})},e.setTargetPlace=function(t){u.details(t.place_id).success(function(t){if("OK"==t.status){var r=t.result;if(e.isCountry(r))return void(e.gacValidationMessage="Ein Land kann nicht als Ziel gewählt werden!");r.geometry&&(e.gacValidationMessage="",e.TargetLat=r.geometry.location.lat,e.TargetLon=r.geometry.location.lng,"Deutschland"===r.formatted_address?e.TargetName=r.name+", "+r.formatted_address:e.TargetName=r.formatted_address,e.targetIsValid=!0,e.targetPredictions=[],e.TargetLatLng=new google.maps.LatLng(r.geometry.location.lat,r.geometry.location.lng),e.TargetCountry=n.getPlaceCountry(r),e.renderMapIfReady(!0))}})},e.setStatus=function(t){e.locked&&(r.search("s","o"),t="o"),r.search("s",t),"d"===t?(n.scrollTo("mapPanel"),e.showMap=!0,e.showNameSection=!1,e.showOfferSection=!1,l.pageView("/app/dates")):"n"===t?(e.showMap=!0,e.showNameSection=!0,e.showOfferSection=!1,n.scrollTo("namePanel"),l.pageView("/app/passengers")):"o"===t?(e.locked=!0,e.offersLoading=!0,c.offers(e.requestId).then(function(t){e.offers=t,angular.forEach(e.offers,function(e){e.safeProductDescription=s.trustAsHtml(e.productDescription)}),e.offersLoading=!1}),e.showMap=!0,e.showNameSection=!0,e.showOfferSection=!0,n.scrollTo("offerPanel"),l.pageView("/app/offers")):(e.showMap=!1,e.showNameSection=!1,e.showOfferSection=!1,l.pageView("/app/places"))},e.getRequestId=function(){return e.locked?c.create().success(function(t){r.search("r",t),e.requestId=t,e.locked=!1,e.showOfferSection=!1}):a.when()},e.save=function(t){return e.getRequestId().then(function(a){var o=(e.Request.StartDate.$modelValue,{RequestId:e.requestId,StartName:e.StartName,StartCountry:e.StartCountry,StartLat:e.StartLat,StartLon:e.StartLon,TargetName:e.TargetName,TargetCountry:e.TargetCountry,TargetLat:e.TargetLat,TargetLon:e.TargetLon,Distance:e.distance,Duration:e.duration,StartDate:n.isoDateString(e.Request.StartDate.$modelValue),StartTime:e.StartTime,StartTimeMode:e.StartTimeMode,ReturnDate:n.isoDateString(e.Request.ReturnDate.$modelValue),ReturnTime:e.ReturnTime,ReturnTimeMode:e.ReturnTimeMode,Passengers:e.Passengers,Name:e.Name,Email:e.EMail,Phone:e.Telephone,TripType:e.isOneWay?"OneWay":"Return",BusShouldStay:e.busShouldStay});return c.update(o).then(function(a){return"CannotQuote"==a.data.status&&(r.path("/cannotQuote/"+e.requestId),r.search({})),e.startTimeArrive=a.data.startTimeArrive,e.startTimeDepart=a.data.startTimeDepart,e.returnTimeArrive=a.data.returnTimeArrive,e.returnTimeDepart=a.data.returnTimeDepart,e.requestNumber=a.data.number,"undefined"!=typeof t&&e.setStatus(t),a})})},e.invalidate=function(t){e.initFinished&&("start"===t?(e.startIsValid=!1,e.StartLatLng=null,r.search("s",""),e.showMap=!1,e.showNameSection=!1,e.showOfferSection=!1):"target"===t?(e.targetIsValid=!1,e.TargetLatLng=null,r.search("s",""),e.showMap=!1,e.showNameSection=!1,e.showOfferSection=!1):"dates"===t&&(r.search("s","d"),e.showNameSection=!1,e.showOfferSection=!1,e.showOfferSection=!1))},e.displayDistance=function(){if(0==e.duration)return"";var t=Math.floor(e.duration/60),r=e.duration-60*t,a=" "+e.distance+" km, ";return 0==t||(1==t?a+=" 1 Stunde ":a=a+t+" Stunden "),1==r?a+=" 1 Minute":a=a+r+" Minuten",a},e.renderMapIfReady=function(r){return null==e.StartLatLng||null==e.TargetLatLng?(e.distance=0,void(e.duration=0)):(e.mapLoading=!0,e.showMap=!0,void t(function(){if(null==e.map){var t={scrollwheel:!1,navigationControl:!1,mapTypeControl:!1,scaleControl:!1,draggable:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(50,10),zoom:5};e.map=new google.maps.Map(document.getElementById("map-canvas"),t),e.dr.setMap(e.map)}r&&n.scrollTo("mapPanel"),e.ds.route({origin:e.StartLatLng,destination:e.TargetLatLng,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC},function(t,a){a==google.maps.DirectionsStatus.OK?(e.dr.setDirections(t),r?e.save().then(function(t){e.distance=t.data.distance,e.duration=t.data.duration,e.setStatus("d"),e.mapLoading=!1}):e.mapLoading=!1):(e.distance=0,e.duration=0,e.mapLoading=!1)})}))},e.dateSectionSubmitted=!1,e.startTimeArrive="",e.startTimeDepart="",e.returnTimeArrive="",e.returnTimeDepart="",e.dateOptionsStart=$.extend({},$.datepicker.regional.de,{minDate:"+1w",numberOfMonths:3}),e.dateOptionsReturn=$.extend({},$.datepicker.regional.de,{minDate:"+1w",numberOfMonths:3}),e.$watch("StartDate",function(t){e.dateOptionsReturn.minDate=t,null==e.ReturnDate&&null!=t&&(e.Request.ReturnDate.$setViewValue(t),e.ReturnDate=t)}),e.$watch("ReturnDate",function(t){e.dateOptionsStart.maxDate=t}),e.isDateSectionValid=function(){return e.Request.StartDate.$valid&&e.Request.ReturnDate.$valid},e.startDateErrorClass=function(){return e.Request.StartDate.$dirty||e.dateSectionSubmitted?e.Request.StartDate.$valid?"has-success":"has-error":""},e.returnDateErrorClass=function(){return e.Request.ReturnDate.$dirty||e.dateSectionSubmitted?e.Request.ReturnDate.$valid?"has-success":"has-error":""},e.submitDateSection=function(){e.dateSectionSubmitted=!0,l.buttonClick("dates"),e.isDateSectionValid()&&e.save("n")},e.nameSectionSubmitted=!1,e.passengersEdited=function(){e.initFinished&&e.locked&&(e.nameSectionSubmitted=!1,e.getRequestId().then(function(){e.save(),e.setStatus("n")}))},e.passengerErrorClass=function(){return e.Request.Passengers.$dirty||e.nameSectionSubmitted?e.Request.Passengers.$valid?"has-success":"has-error":""},e.nameErrorClass=function(){return e.Request.Name.$dirty||e.nameSectionSubmitted?e.Request.Name.$valid?"has-success":"has-error":""},e.emailErrorClass=function(){return e.Request.EMail.$dirty||e.nameSectionSubmitted?e.Request.EMail.$valid?"has-success":"has-error":""},e.telephoneErrorClass=function(){return e.Request.Telephone.$dirty||e.nameSectionSubmitted?e.Request.Telephone.$valid?"has-success":"has-error":""},e.nameSectionValid=function(){return e.Request.$valid},e.submitNameSection=function(){e.nameSectionSubmitted=!0,l.buttonClick("passengers"),e.nameSectionValid()&&(e.offersLoading=!0,e.save().then(function(){l.offersDisplayed(),e.setStatus("o")}))},e.detectInitialState=function(){var t=r.search();t.hasOwnProperty("r")?(e.requestId=t.r,c.get(t.r).success(function(a){if(e.requestNumber=a.number,a.hasOwnProperty("startLat")&&(e.Request.StartName.$setViewValue(e.Request.StartName.$setViewValue),e.StartName=a.startName,e.StartCountry=a.startCountry,e.StartLat=a.startLat,e.StartLon=a.startLon,e.StartLatLng=new google.maps.LatLng(a.startLat,a.startLon),e.startIsValid=!0,e.Request.TargetName.$setViewValue(e.Request.TargetName.$setViewValue),e.TargetName=a.targetName,e.TargetCountry=a.targetCountry,e.TargetLat=a.targetLat,e.TargetLon=a.targetLon,e.TargetLatLng=new google.maps.LatLng(a.targetLat,a.targetLon),e.targetIsValid=!0,e.distance=a.distance,e.duration=a.duration,e.renderMapIfReady(!1)),null!=a.startDate){var o=new Date(a.startDate),i=new Date(a.returnDate);e.Request.StartDate.$setViewValue(o),e.StartDate=o,e.StartTime=f(o.getUTCHours())+":"+f(o.getUTCMinutes()),e.Request.ReturnDate.$setViewValue(i),e.ReturnDate=i,e.ReturnTime=f(i.getUTCHours())+":"+f(i.getUTCMinutes()),e.startTimeArrive=a.startTimeArrive,e.startTimeDepart=a.startTimeDepart,e.returnTimeArrive=a.returnTimeArrive,e.returnTimeDepart=a.returnTimeDepart,e.StartTimeMode=a.startTimeMode,e.ReturnTimeMode=a.returnTimeMode}e.busShouldStay=a.busShouldStay,"OneWay"==a.tripType?e.isOneWay=!0:e.isOneWay=!1,a.passengers>0&&(e.Passengers=a.passengers),e.Name=a.name,e.EMail=a.email,e.Telephone=a.phone,e.locked=a.isLocked,e.locked&&("recalc"===t.s?(r.search("s","n"),t.s="n",a.isOfferExpired=!1):(r.search("s","o"),t.s="o")),"d"===t.s?(n.scrollTo("mapPanel"),l.pageView("/app/dates")):"n"===t.s?(e.showNameSection=!0,n.jumpTo("namePanel"),l.pageView("/app/passengers")):"o"===t.s?(e.locked=!0,e.offersLoading=!0,c.offers(e.requestId).then(function(t){e.offers=t,angular.forEach(e.offers,function(e){e.safeProductDescription=s.trustAsHtml(e.productDescription)}),e.offersLoading=!1}),e.showNameSection=!0,e.showOfferSection=!0,n.jumpTo("offerPanel"),l.pageView("/app/offers")):l.pageView("/app/places"),a.isOfferExpired&&r.path("/offerExpired/"+e.requestId),e.initFinished=!0}).error(function(e){o.error(e)})):(e.initFinished=!0,l.pageView("/app/places"))},e.detectInitialState(),e.isMailFormShown=!1,e.emailForSending="",e.emailBeingSent=!1,e.mailSendSuccess=!1,e.print=function(){i.print()},e.showMailForm=function(){e.emailForSending=e.EMail,e.isMailFormShown=!0},e.sendMail=function(){e.emailBeingSent=!0,d.sendMail({Id:e.requestId,Type:"offer",Email:e.emailForSending}).success(function(){e.emailBeingSent=!1,e.mailSendSuccess=!0,t(function(){e.mailSendSuccess=!1,e.isMailFormShown=!1},2e3)})}}]),app.controller("SpecialRequestController",["$scope","$routeParams","$window","$log","$sce","$location","requestFactory","request","analyticsFactory",function(e,t,r,a,n,o,s,i,u){e.request=i.data,e.requestId=t.requestId,e.success=!1,e.$on("$viewContentLoaded",function(e){u.pageView("/app/specialrequest")}),$("body,html").scrollTop(0),e.submit=function(){$("body,html").scrollTop(0),s.update({RequestId:e.requestId,HasSpecialRequests:!0,SpecialRequests:e.SpecialRequests}).success(function(){e.success=!0}).error(function(e){})}}]),app.directive("dateField",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,a){function n(e){if("undefined"==typeof e)return"";var t=e.getDate(),r=e.getMonth(),a=e.getFullYear();return t+"."+(r+1)+"."+a}a.$formatters.push(n)}}}),app.directive("viewportHeight",["$window",function(e){return{restrict:"A",link:function(t,r){var a=angular.element(e);t.getWindowDimensions=function(){return{h:a.height(),w:a.width()}},t.$watch(t.getWindowDimensions,function(e,r){t.windowHeight=e.h,t.windowWidth=e.w,t.style=function(){return e.w<768?{}:{"padding-top":(e.h-700)/2,height:e.h-140+"px"}}},!0),a.bind("resize",function(){t.$apply()})}}}]),app.factory("analyticsFactory",["$window","$location","$log",function(e,t,r){var a={},n=function(r){"undefined"!=typeof r?e.ga("send","pageview",{page:r}):e.ga("send","pageview",{page:t.url()})},o=function(t){e.ga("send","event","button","click",t)},s=function(){e.ga("send","event","quotation","display","offers")};return a.pageView=n,a.buttonClick=o,a.offersDisplayed=s,a}]),app.factory("bookingFactory",["$http","apiEndPoint","clientId",function(e,t,r){var a={},n=function(r){return e.post(t+"booking",r)},o=function(r){return e.post(t+"paymentresult",r)};return a.book=n,a.pay=o,a}]),app.factory("gacFactory",["$http","apiEndPoint",function(e,t){var r={},a=function(r){return e.post(t+"maps/autocomplete",{Input:r})},n=function(r){return e.post(t+"maps/details",{PlaceId:r})};return r.autocomplete=a,r.details=n,r}]),app.factory("mailerFactory",["$http","apiEndPoint","clientId",function(e,t,r){var a={},n=function(r){return e.post(t+"mailer",r)};return a.sendMail=n,a}]),app.factory("requestFactory",["$http","$q","apiEndPoint","clientId",function(e,t,r,a){var n={},o=function(){return e.post(r+"request/new",{ClientId:a})},s=function(t){return e.post(r+"request",t)},i=function(t){return e.post(r+"request",{RequestId:t})},u=function(a){return t(function(t,n){e.post(r+"offer?RequestId="+a).then(function(e){var r=e.data,a="<b>Kein Angebot m&ouml;glich.</b><div>In dieser Kategorie k&ouml;nnen wir Ihnen momentan leider kein Sofortangebot unterbreiten. Bitte kontaktieren Sie uns f&uuml;r ein individuelles Angebot.</div>";r.length<1&&r.push({productName:"Standard",productDescription:a,noOffer:!0}),r.length<2&&r.push({productName:"Komfort",productDescription:a,noOffer:!0}),r.length<3&&r.push({productName:"Luxus",productDescription:a,noOffer:!0}),t(r)})})},c=function(t,a){return e.post(r+"offer?RequestId="+t+"&OfferId="+a)};return n.create=o,n.update=s,n.get=i,n.offers=u,n.offer=c,n}]),app.factory("utilFactory",["$timeout","$log","$q",function(e,t,r){var a={};return a.cumulativeOffset=function(e){var t=0,r=0;do t+=e.offsetTop||0,r+=e.offsetLeft||0,e=e.offsetParent;while(e);return{top:t,left:r}},a.jumpTo=function(r){e(function(){var e=document.getElementById("mainNavbar"),n=e.clientHeight,o=document.getElementById(r),s=a.cumulativeOffset(o).top-n-10;t.info("nav is "+n+" high, jumping to "+s),$("body,html").scrollTop(s)},500)},a.scrollTo=function(r){e(function(){var e=document.getElementById("mainNavbar"),n=e.clientHeight,o=document.getElementById(r),s=a.cumulativeOffset(o).top-n-10;t.info("nav is "+n+" high, scolling to "+s),$("body,html").animate({scrollTop:s},"slow")},500)},a.preloadImage=function(e){var t=r.defer(),a=new Image;return a.src=e,a.complete?t.resolve():(a.addEventListener("load",function(){t.resolve()}),a.addEventListener("error",function(){t.reject()})),t.promise},a.getPlaceCountry=function(e){for(var t=0;t<e.address_components.length;t++)for(var r=0;r<e.address_components[t].types.length;r++)if("country"==e.address_components[t].types[r])return e.address_components[t].short_name;return"UNKNOWN"},a.isoDateString=function(e){if("undefined"==typeof e)return null;var t=e.getDate(),r=e.getMonth(),a=e.getFullYear();return a+"-"+(r+1)+"-"+t},a}]);